@model CrearVentaVm
@{
    ViewData["Title"] = "Registrar Venta";
}
<h2>Registrar Venta</h2>

<form asp-action="Crear" method="post" id="ventaForm">
    <div class="mb-3">
        <label>Cliente</label>
        <select asp-for="ClienteId" class="form-select">
            <option value="">-- Seleccione --</option>
            @foreach (var c in Model.Clientes)
            {
                <option value="@c.Id">@c.Nombre (@c.Email)</option>
            }
        </select>
    </div>

    <div class="row">
        <div class="col-md-6">
            <h4>Productos</h4>
            <table class="table">
                <thead><tr><th>Nombre</th><th>Precio</th><th>Stock</th><th>Cantidad</th><th></th></tr></thead>
                <tbody>
                    @foreach (var p in Model.Productos)
                    {
                        <tr>
                            <td>@p.Nombre</td>
                            <td>@p.Precio.ToString("C")</td>
                            <td>@p.Stock</td>
                            <td><input type="number" id="qty_@p.Id" class="form-control" value="1" min="1" max="@p.Stock" /></td>
                            <td><button type="button" class="btn btn-sm btn-success" onclick="addToCart(@p.Id, '@p.Nombre', @p.Precio)">Agregar</button></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="col-md-6">
            <h4>Carrito</h4>
            <table class="table" id="cartTable">
                <thead><tr><th>Producto</th><th>Precio</th><th>Cantidad</th><th>Subtotal</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
            <h5>Total: <span id="total">Q0.00</span></h5>
        </div>
    </div>

    <input type="hidden" name="Items" id="itemsInput" />
    <button class="btn btn-primary" type="submit">Enviar Venta</button>
</form>

@section Scripts {
    <script>
        let cart = [];

        function addToCart(id, nombre, precio) {
            const qtyInput = document.getElementById('qty_' + id);
            const qty = parseInt(qtyInput.value) || 1;
            const existing = cart.find(c => c.productoId === id);
            if (existing) existing.cantidad += qty;
            else cart.push({ productoId: id, nombre, precio, cantidad: qty });
            renderCart();
        }

        function removeFromCart(id) {
            cart = cart.filter(c => c.productoId !== id);
            renderCart();
        }

        function renderCart() {
            const tbody = document.querySelector('#cartTable tbody');
            tbody.innerHTML = '';
            let total = 0;
            cart.forEach(item => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.nombre}</td><td>${item.precio.toFixed(2)}</td><td>${item.cantidad}</td><td>${subtotal.toFixed(2)}</td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeFromCart(${item.productoId})">X</button></td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('total').innerText = total.toFixed(2);
            document.getElementById('itemsInput').value = JSON.stringify(cart.map(c => ({ productoId: c.productoId, cantidad: c.cantidad })));
        }

        document.getElementById('ventaForm').addEventListener('submit', function(e){
            const itemsVal = document.getElementById('itemsInput').value;
            if (!itemsVal || cart.length === 0) {
                e.preventDefault();
                alert('Agrega al menos un producto al carrito');
                return false;
            }

            document.querySelectorAll('input[name^="Items"]').forEach(i => i.remove());
            cart.forEach((it, idx) => {
                const inputProducto = document.createElement('input');
                inputProducto.type = 'hidden';
                inputProducto.name = `Items[${idx}].ProductoId`;
                inputProducto.value = it.productoId;
                document.getElementById('ventaForm').appendChild(inputProducto);

                const inputCantidad = document.createElement('input');
                inputCantidad.type = 'hidden';
                inputCantidad.name = `Items[${idx}].Cantidad`;
                inputCantidad.value = it.cantidad;
                document.getElementById('ventaForm').appendChild(inputCantidad);
            });
        });
    </script>
}
